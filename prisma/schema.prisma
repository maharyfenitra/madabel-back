generator client {
  provider = "prisma-client-js"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                  Int                     @id @default(autoincrement())
  name                String
  email               String?                 @unique
  phone               String                  @unique
  password            String
  role                Role                    @default(CANDIDAT)
  avatar              String?
  createdAt           DateTime                @default(now())
  post                String?
  deletedAt           DateTime?
  isFirstLogin        Boolean                 @default(true)
  evaluations         EvaluationParticipant[]
  passwordResetTokens PasswordResetToken[]
  refreshTokens       RefreshToken[]
}

model RefreshToken {
  id        Int      @id @default(autoincrement())
  token     String   @unique
  userId    Int
  expiresAt DateTime
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id])
}

model PasswordResetToken {
  id        Int      @id @default(autoincrement())
  token     String   @unique
  userId    Int
  expiresAt DateTime
  used      Boolean  @default(false)
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id])
}

model Evaluation {
  id           Int                     @id @default(autoincrement())
  ref          String                  @unique
  createdAt    DateTime                @default(now())
  deadline     DateTime
  completedAt  DateTime?
  isCompleted  Boolean                 @default(false)
  role         String?
  updatedAt    DateTime                @updatedAt
  quizId       Int?
  answers      Answer[]
  quiz         Quiz?                   @relation(fields: [quizId], references: [id])
  participants EvaluationParticipant[]
}

model EvaluationParticipant {
  id              Int            @id @default(autoincrement())
  evaluationId    Int
  userId          Int
  participantRole Role
  createdAt       DateTime       @default(now())
  evaluatorType   EvaluatorType?
  mailSentAt      DateTime?
  reminderSentAt  DateTime?
  reminderCount   Int            @default(0)
  completedAt     DateTime?
  answers         Answer[]
  evaluation      Evaluation     @relation(fields: [evaluationId], references: [id])
  user            User           @relation(fields: [userId], references: [id])

  @@unique([evaluationId, userId])
}

/// Un questionnaire (template) contenant plusieurs questions
model Quiz {
  id          Int          @id @default(autoincrement())
  title       String
  description String?
  isActive    Boolean      @default(true)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  deletedAt   DateTime?
  evaluations Evaluation[]
  questions   Question[]
}

/// Question du quiz (texte, type, ordre, poids, langue...)
model Question {
  id              Int              @id @default(autoincrement())
  quizId          Int
  text            String
  type            QuestionType     @default(SINGLE_CHOICE)
  order           Int              @default(0)
  weight          Float?
  language        String?          @default("fr")
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  correctNumeric  Float?
  correctOptionId Int?
  correctText     String?
  category        QuestionCategory @default(PRODUCTION)
  subcategory     PinnacleSubcategory?
  developOthers   Boolean          @default(false)
  answers         Answer[]
  options         Option[]
  correctOption   Option?          @relation("CorrectOption", fields: [correctOptionId], references: [id])
  quiz            Quiz             @relation(fields: [quizId], references: [id])
}

/// Option (choix) pour une question
model Option {
  id                  Int            @id @default(autoincrement())
  questionId          Int
  text                String
  value               Int?
  isKey               Boolean?       @default(false)
  createdAt           DateTime       @default(now())
  selectedByAnswers   Answer[]
  answerSelections    AnswerOption[]
  question            Question       @relation(fields: [questionId], references: [id])
  correctForQuestions Question[]     @relation("CorrectOption")
}

model Answer {
  id                      Int                    @id @default(autoincrement())
  evaluationParticipantId Int?
  questionId              Int
  selectedOptionId        Int?
  textAnswer              String?
  numericAnswer           Float?
  createdAt               DateTime               @default(now())
  evaluationId            Int?
  isDraft                 Boolean                @default(false)
  submittedAt             DateTime?
  updatedAt               DateTime               @default(now()) @updatedAt
  evaluation              Evaluation?            @relation(fields: [evaluationId], references: [id], onDelete: Cascade)
  evaluationParticipant   EvaluationParticipant? @relation(fields: [evaluationParticipantId], references: [id], onDelete: Cascade)
  question                Question               @relation(fields: [questionId], references: [id], onDelete: Cascade)
  selectedOption          Option?                @relation(fields: [selectedOptionId], references: [id], onDelete: Cascade)
  selectedOptions         AnswerOption[]
}

model AnswerOption {
  id       Int    @id @default(autoincrement())
  answerId Int
  optionId Int
  answer   Answer @relation(fields: [answerId], references: [id], onDelete: Cascade)
  option   Option @relation(fields: [optionId], references: [id], onDelete: Cascade)

  @@unique([answerId, optionId])
}

model SystemConfig {
  id                Int               @id @default(autoincrement())
  reminderFrequency ReminderFrequency @default(DAILY_1)
  reminderEnabled   Boolean           @default(true)
  lastReminderCheck DateTime?
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt

  @@map("system_config")
}

enum Role {
  ADMIN
  EVALUATOR
  CANDIDAT
}

enum EvaluatorType {
  DIRECT_MANAGER
  DIRECT_COLLEAGUE
  PEER
  OTHER
}

/// Types de question supportés
enum QuestionType {
  SINGLE_CHOICE
  MULTIPLE_CHOICE
  TEXT
  SCALE
}

/// Catégories de questions
enum QuestionCategory {
  POSITION
  PERMISSION
  PRODUCTION
  PINNACLE
}

/// Sous-catégories pour PINNACLE
enum PinnacleSubcategory {
  SOI
  AUTRES
}

/// Fréquences de relance disponibles
enum ReminderFrequency {
  HOURLY_1
  HOURLY_2
  DAILY_1
  DAILY_3
  WEEKLY_1
}
