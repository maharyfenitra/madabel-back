generator client {
  provider = "prisma-client-js"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

//
// üßç Utilisateur principal
//
model User {
  id            Int                      @id @default(autoincrement())
  name          String
  email         String?                  @unique
  phone         String                   @unique
  post          String?
  // Soft delete timestamp: when set, user is considered deleted
  deletedAt     DateTime?
  password      String
  role          Role                     @default(CANDIDAT)
  avatar        String?
  createdAt     DateTime                 @default(now())

  // üîê Auth
  refreshTokens RefreshToken[]

  // üßæ Relations avec les √©valuations (via la table de jonction)
  evaluations   EvaluationParticipant[]
}

//
// üîê Token d'authentification
//
model RefreshToken {
  id        Int      @id @default(autoincrement())
  token     String   @unique
  user      User     @relation(fields: [userId], references: [id])
  userId    Int
  expiresAt DateTime
  createdAt DateTime @default(now())
}

//
// üìä Table principale : √âvaluation
//
model Evaluation {
  id           Int                       @id @default(autoincrement())
  ref          String                    @unique
  createdAt    DateTime                  @default(now())
  deadline     DateTime
  completedAt  DateTime?
  isCompleted  Boolean                   @default(false)
  role         String?
  
  // üîó Relation avec les participants (candidats et √©valuateurs)
  participants EvaluationParticipant[]

  // timestamps
  updatedAt    DateTime                  @updatedAt
}

//
// üë• Table d'association : relie les utilisateurs √† une √©valuation
//
model EvaluationParticipant {
  id             Int          @id @default(autoincrement())
  evaluation     Evaluation   @relation(fields: [evaluationId], references: [id])
  evaluationId   Int
  user           User         @relation(fields: [userId], references: [id])
  userId         Int

  // ‚úÖ Permet de diff√©rencier si la personne est "CANDIDAT" ou "EVALUATOR"
  participantRole Role

  evaluatorType   EvaluatorType?

  createdAt      DateTime     @default(now())

  @@unique([evaluationId, userId]) // emp√™che les doublons
}

//
// üìú √ânum√©rations
//
enum Role {
  ADMIN
  EVALUATOR
  CANDIDAT
}

enum EvaluatorType {
  DIRECT_MANAGER         // Manager Direct
  DIRECT_COLLEAGUE       // Collaborateur Direct
  PEER                   // Pair/Associ√©
  OTHER                  // Autres (client/fournisseur/famille/amis/etc.)
}

// --------------------------------------------------
// Mod√®les pour stocker les questionnaires et questions
// --------------------------------------------------

/// Un questionnaire (template) contenant plusieurs questions
model Quiz {
  id          Int        @id @default(autoincrement())
  title       String
  description String?
  isActive    Boolean    @default(true)

  // Questions appartenant √† ce quiz
  questions   Question[]

  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
}

/// Question du quiz (texte, type, ordre, poids, langue...)
model Question {
  id        Int          @id @default(autoincrement())
  quiz      Quiz         @relation(fields: [quizId], references: [id])
  quizId    Int

  text      String
  type      QuestionType @default(SINGLE_CHOICE)
  order     Int          @default(0)
  weight    Float?
  language  String?      @default("fr")

  // Options / choix li√©s √† la question (pour choice questions)
  options   Option[]

  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt
}

/// Option (choix) pour une question
model Option {
  id         Int      @id @default(autoincrement())
  question   Question @relation(fields: [questionId], references: [id])
  questionId Int

  text       String
  // Valeur num√©rique associ√©e au choix (utile pour scoring, √©chelles...)
  value      Int?
  // Indique si c'est la r√©ponse clef (optionnel, utile pour quizzes √† correction automatique)
  isKey      Boolean? @default(false)

  createdAt  DateTime @default(now())
}

/// Types de question support√©s
enum QuestionType {
  SINGLE_CHOICE
  MULTIPLE_CHOICE
  TEXT
  SCALE
}